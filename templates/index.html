<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}MCP 입찰 정보 수집 서버 - 대시보드{% endblock %}

{% block content %}
<div class="card">
    <h1>MCP 입찰 정보 수집 서버</h1>
    <p>UNGM과 TED 입찰 공고를 자동으로 수집하고 관리하는 시스템입니다.</p>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="total-tenders">-</div>
            <div>총 입찰 공고</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="ungm-count">-</div>
            <div>UNGM 공고</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="ted-count">-</div>
            <div>TED 공고</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="sam-count">-</div>
            <div>SAM.gov 공고</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="today-count">-</div>
            <div>오늘 수집</div>
        </div>
    </div>
    
    <div style="margin-top: 2rem;">
        <h3>빠른 작업</h3>
        <a href="/api/crawl" class="btn" onclick="return manualCrawl(event)">수동 크롤링 실행</a>
        <a href="/tenders" class="btn">최근 입찰 보기</a>
        <a href="/search-config" class="btn">검색 설정</a>
    </div>
    
    <div id="crawl-status" class="alert alert-info" style="display: none;">
        크롤링 진행 중...
    </div>
</div>

<script>
// 통계 데이터 로드
async function loadStats() {
    try {
        const response = await fetch('/api/tenders?limit=1000');
        const data = await response.json();

        const totalCount = data.total;
        const ungmCount = data.tenders.filter(t => t.site === 'UNGM').length;
        const tedCount = data.tenders.filter(t => t.site === 'TED').length;
        const samCount = data.tenders.filter(t => t.site === 'SAM').length;

        const today = new Date().toISOString().split('T')[0];
        const todayCount = data.tenders.filter(t =>
            t.published_date && t.published_date.startsWith(today)
        ).length;

        document.getElementById('total-tenders').textContent = totalCount;
        document.getElementById('ungm-count').textContent = ungmCount;
        document.getElementById('ted-count').textContent = tedCount;
        document.getElementById('sam-count').textContent = samCount;
        document.getElementById('today-count').textContent = todayCount;
    } catch (error) {
        console.error('통계 로드 실패:', error);
    }
}

// 수동 크롤링 실행
async function manualCrawl(event) {
    event.preventDefault();
    
    const statusDiv = document.getElementById('crawl-status');
    statusDiv.style.display = 'block';
    statusDiv.textContent = '크롤링 진행 중...';
    
    try {
        const response = await fetch('/api/crawl', {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.status === 'success') {
            statusDiv.textContent = '크롤링 완료! 페이지를 새로고침하여 업데이트된 데이터를 확인하세요.';
            statusDiv.className = 'alert alert-success';
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            statusDiv.textContent = '크롤링 실패: ' + result.message;
            statusDiv.className = 'alert alert-danger';
        }
    } catch (error) {
        statusDiv.textContent = '크롤링 요청 실패: ' + error.message;
        statusDiv.className = 'alert alert-danger';
    }
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
        statusDiv.className = 'alert alert-info';
    }, 5000);
    
    return false;
}

// 페이지 로드 시 통계 데이터 로드
document.addEventListener('DOMContentLoaded', loadStats);
</script>
{% endblock %}